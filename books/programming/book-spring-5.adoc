= Spring в действии. Глава 5. Основы безопасности Spring Security

Spring Security — мощный фреймворк для аутентификации и авторизации:

* Автоматически защищает все endpoints от неавторизованного доступа
* Основан на фильтрах Servlet, которые перехватывают запросы

==  Конфигурация безопасности
Для настройки доступа в соответствии с адресами необходимо настроить метод filterChain

== Аутентификация (Authentication)
- В памяти (In-memory)
- JDBC-аутентификация с использованием базы данных
- LDAP-аутентификация
- Пользовательские сервисы с реализацией `UserDetailsService`
- Информацию об аутентифицированном пользователе можно получить через объект SecurityContext (возвращаемый из SecurityContextHolder.getContext()) или @AuthenticationPrincipal.

==  Авторизация
- Разграничение доступа на основе ролей (`hasRole()`, `hasAuthority()`)
- Разрешения для разных HTTP-методов
- Аннотации безопасности: `@PreAuthorize`, `@PostAuthorize`

== Форма входа
- Spring Security предоставляет стандартную форму входа
- Возможность кастомизации страницы входа
- Обработка успешной и неуспешной аутентификации (через login(), logout(), redirect())

== Защита от CSRF-атак (Подделка межсайтовых запросов)
Подделка межсайтовых запросов (Cross-Site Request Forgery, CSRF) – распространенный вид атак на системы безопасности.
Такие атаки предполагают предоставление вредоносной веб-страницы пользователю, которая автоматически (и обычно тайно) отправляет заполненную форму
другому приложению, причиняя пользователю тот или иной ущерб. Например, на злонамеренном веб-сайте пользователю
может быть предложено заполнить форму, которая автоматически отправляет сообщение на URL банковского веб-сайта пользователя (предположительно слабо защищенный и уязвимый для такой атаки) с запросом на перевод денег. Пользователь может даже не подозревать, что произошла атака, пока не заметит пропажу денег со своего счета.
Для защиты от таких атак приложения могут генерировать токен CSRF, помещать этот токен в скрытое поле формы, а затем сохранять
его для последующего использования на сервере. Когда пользователь возвращает заполненную форму, вместе с ней на сервер возвращается и токен, который затем сравнивается на сервере с первоначально сгенерированным токеном. Если токен совпадает, обработка запроса продолжается как обычно. В противном случае это может означать, что форма сгенерирована вредоносным веб-сайтом, которому неизвестен токен, сгенерированный сервером.

- Spring Security автоматически защищает от CSRF
- Использует токены для проверки легитимности запросов
- Важно включать CSRF-токен в формы

== Хранение паролей
- **Шифрование паролей** с помощью `PasswordEncoder`
- Рекомендуется использовать `BCryptPasswordEncoder`
- Не хранить пароли в открытом виде

== Тестирование безопасности
- Тестирование защищенных endpoints
- Использование `@WithMockUser` для имитации пользователя

== Ключевые аннотации
- `@EnableWebSecurity` — активация безопасности
- `@PreAuthorize("hasRole('USER')")` — проверка доступа перед выполнением метода
- `@PostAuthorize` — проверка после выполнения метода

==  Best Practices
- Всегда шифровать пароли
- Использовать принцип минимальных привилегий
- Регулярно обновлять зависимости безопасности
- Настраивать HTTPS в production